<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.java.mybatis.mapper.UserMapper">
    <!-- 회원가입 -->
    <insert id="insertUserLogin" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_login (username, password)
        VALUES (#{username}, #{password})
    </insert>
    <insert id="insertUserInfo">
        INSERT INTO user_info (login_id, nickname, email)
        VALUES (#{loginId}, #{nickname}, #{email})
    </insert>
    <!-- ResultMap -->
    <!-- 기본 ResultMap -->
    <resultMap id="userLoginMap" type="UserLogin">
        <id property="id" column="id"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 1:1 관계 ResultMap -->
    <resultMap id="userInfoMap" type="UserInfo">
        <id property="id" column="id"/>
        <result property="loginId" column="login_id"/>
        <result property="nickname" column="nickname"/>
        <result property="email" column="email"/>
        <result property="createdAt" column="created_at"/>

        <!-- association: 1:1 관계 매핑 -->
        <association property="userLogin" javaType="UserLogin">
            <id property="id" column="login_id"/>
            <result property="username" column="username"/>
        </association>
    </resultMap>

    <!-- 로그인 정보 조회 -->
    <select id="findLoginByUsername" resultMap="userLoginMap">
        SELECT * FROM user_login WHERE username = #{username}
    </select>

    <!-- 사용자 정보 조회 (1:1 조인) -->
    <select id="findUserInfoByLoginId" resultMap="userInfoMap">
        SELECT
            ui.id, ui.login_id, ui.nickname, ui.email, ui.created_at,
            ul.username
        FROM user_info ui
                 INNER JOIN user_login ul ON ui.login_id = ul.id
        WHERE ui.login_id = #{loginId}
    </select>

    <!-- 1:N 관계 ResultMap -->
    <resultMap id="userInfoWithPostsMap" type="UserInfo" extends="userInfoMap">
        <collection property="posts" ofType="Post">
            <id property="id" column="post_id"/>
            <result property="title" column="title"/>
        </collection>
    </resultMap>
    <!-- 사용자 정보 조회 (1:N 조인) -->
    <select id="findUserWithPosts" resultMap="userInfoWithPostsMap">
        SELECT
            ui.id, ui.login_id, ui.nickname, ui.email, ui.created_at,
            ul.username,
            p.id AS post_id, p.title
        FROM user_info ui
                 INNER JOIN user_login ul ON ui.login_id = ul.id
                 LEFT JOIN post p ON ui.id = p.author_id
        WHERE ui.id = #{userInfoId}
    </select>
    <!-- M:N 관계 ResultMap -->
    <resultMap id="userInfoWithLikedPostsMap" type="UserInfo" extends="userInfoMap">
        <collection property="likedPosts" ofType="Post">
            <id property="id" column="post_id"/>
            <result property="title" column="title"/>
        </collection>
    </resultMap>
    <!-- 사용자 정보 조회 (M:N 조인) -->
    <select id="findUserWithLikedPosts" resultMap="userInfoWithLikedPostsMap">
        SELECT
            ui.id, ui.login_id, ui.nickname, ui.email, ui.created_at,
            ul.username,
            p.id AS post_id, p.title
        FROM
            user_info ui
                INNER JOIN user_login ul ON ui.login_id = ul.id
                LEFT JOIN post_like pl ON ui.id = pl.user_id
                LEFT JOIN post p ON pl.post_id = p.id
        WHERE ui.id = #{userInfoId}
    </select>
</mapper>